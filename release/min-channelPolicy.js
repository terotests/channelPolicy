(function(){var n={},r=function(){var r=function(){!function(n){n.guid=function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},n.isArray=function(n){return n instanceof Array},n.isFunction=function(n){return"[object Function]"==Object.prototype.toString.call(n)},n.isObject=function(n){return n===Object(n)}}(this),function(n){var r;n.hasOwnProperty("__factoryClass")||(n.__factoryClass=[]),n.__factoryClass.push(function(n){return r||(r={}),r[n]?r[n]:void(r[n]=this)}),n._pseudoClientOnUpdate=function(){var n=this,r=this._channelId;socket.on("frame_"+r,function(r){var e=r.data,t=n._data;console.log("--- incoming to "+socket.getEnum()+"--- "),console.log(JSON.stringify(r));var a=n._data.getJournalLine();if(a==e.from)return console.log("--- incoming ok --- "),n._logJournal(),e.commands.forEach(function(r){n._data.execCmd(n._transformCmdToNs(r,myNamespace))&&n._currentFrame.from++}),n._lastGoodIndex=n._data._journalPointer,void n._logJournal();if(console.log("--- incoming had problems --- "),n._logJournal(),n._pendingFrames.length>0){console.log("--- there were pending frames --- "),n._pendingFrames.forEach(function(n){n._didFail=!0}),t.reverseToLine(e.from);for(var o=0;o<e.commands.length;o++){var i=e.commands[o];if(!n._data.execCmd(n._transformCmdToNs(i,myNamespace))){console.error("syncing frames failed, buffer out of order"),console.error(JSON.stringify(i)),console.error(t._data.data[i[1]]);break}s++}return n._lastGoodIndex=n._data._journalPointer,n._logJournal(),console.log("--- done --- "),void n._createTransaction()}console.log("--- trying to run cmds  --- ");var c=t._journal.splice(e.from,a-e.from),l=t._journalPointer;t._journalPointer-=a-e.from;for(var s=0,f=e.commands.length,u=!1,o=0;f>o;o++){var i=e.commands[o];if(!n._data.execCmd(n._transformCmdToNs(i,myNamespace))){u=!0;break}s++}if(u){console.log("--- run failed  --- "),n._logJournal(),console.log("OK cnt "+s),n._data.undo(s),t._journalPointer=l;for(var o,_=c.length;o=c.shift();)t._journal.push(o);t.undo(_),u=!1;for(var o=0;f>o;o++){var i=e.commands[o];if(!n._data.execCmd(n._transformCmdToNs(i,myNamespace))){console.error("syncing frames failed, buffer out of order"),console.error(JSON.stringify(i)),console.error(t._data.data[i[1]]);break}s++}n._lastGoodIndex=n._data._journalPointer,n._logJournal(),n._createTransaction()}else{console.log("--- run was ok  --- "),n._currentFrame.from=t._journalPointer,t._journalPointer+=c.length;for(var o;o=c.shift();)t._journal.push(o);n._lastGoodIndex=n._data._journalPointer,n._logJournal()}})},n._pseudoOnFrameServer=function(){var n=me._tManager.execute(cmd.data);n.validCnt>0?(cmd.data.commands.length=n.validCnt,me._model.writeToJournal(cmd.data.commands).then(function(){socket.broadcast.to(cmd.channelId).emit("frame_"+cmd.channelId,cmd),result(n)})):result(n)},n._pseudoRunFrame=function(){var n={id:changeFrame.id,from:changeFrame.from,result:!1,rollBack:!1,failed:[]};if(!changeFrame.id)return n;if(this._done[changeFrame.id])return n;this._done[changeFrame.id]=!0;try{var r=this._channel.getJournalLine();if(changeFrame.from!=r){n.invalidStart=!0,n.result=!1,n.correctStart=changeFrame.from,n.correctLines=[];for(var e=changeFrame.from;r>e;e++)n.correctLines.push(this._channel._journal[e]);return n}for(var t=0,e=0;e<changeFrame.commands.length;e++){var a=changeFrame.commands[e];if(!this._channel.execCmd(a)){if(changeFrame.fail_tolastok){n.validCnt=t;var r=this._channel.getJournalLine();n.correctStart=changeFrame.from,n.correctLines=[];for(var e=changeFrame.from;r>e;e++)n.correctLines.push(this._channel._journal[e])}else{n.validCnt=0,this._channel.undo(t);var r=this._channel.getJournalLine();n.correctStart=changeFrame.from,n.correctLines=[];for(var e=changeFrame.from;r>e;e++)n.correctLines.push(this._channel._journal[e])}return n}t++}0==n.failed.length&&(n.result=!0);var r=this._channel.getJournalLine();n.correctStart=changeFrame.from,n.correctLines=[];for(var e=changeFrame.from;r>e;e++)n.correctLines.push(this._channel._journal[e]);return n.validCnt=t,n}catch(o){return n.result=!1,n}},n.constructDeltaDelta=function(n){var r={},e=n.data,t=e._journal.length;r.c=e._journal.slice(n.last_update[1],t),n.last_update[1]=t},n.deltaClientToServer=function(n,r){try{if(!n.id)return;if(!n.socket_id)return;if(this._done[n.id])return res;this._done[n.id]=!0;{var e=r.data,t=n.lu[0],a=(n.lu[1],r.last_update[0]);r.last_update[1]}if(t!=r.version||a!=t||a>client_verson)return r.lagging_sockets||(r.lagging_sockets={}),void(r.lagging_sockets[n.socket_id]=!0);for(var o=0;o<n.c.length;o++){var i=n.c[o];e.execCmd(i)}}catch(c){}},n.deltaServerToClient=function(){},n.execute=function(n){var r={id:n.id,from:n.from,result:!1,rollBack:!1,failed:[]};if(!n.id)return r;if(this._done[n.id])return r;this._done[n.id]=!0;try{var e=this._channel.getJournalLine();if(n.from!=e){r.invalidStart=!0,r.result=!1,r.correctStart=n.from,r.correctLines=[];for(var t=n.from;e>t;t++)r.correctLines.push(this._channel._journal[t]);return r}for(var a=0,t=0;t<n.commands.length;t++){var o=n.commands[t];if(!this._channel.execCmd(o)){if(n.fail_tolastok){r.validCnt=a;var e=this._channel.getJournalLine();r.correctStart=n.from,r.correctLines=[];for(var t=n.from;e>t;t++)r.correctLines.push(this._channel._journal[t])}else{r.validCnt=0,this._channel.undo(a);var e=this._channel.getJournalLine();r.correctStart=n.from,r.correctLines=[];for(var t=n.from;e>t;t++)r.correctLines.push(this._channel._journal[t])}return r}a++}0==r.failed.length&&(r.result=!0);var e=this._channel.getJournalLine();r.correctStart=n.from,r.correctLines=[];for(var t=n.from;e>t;t++)r.correctLines.push(this._channel._journal[t]);return r.validCnt=a,r}catch(i){return r.result=!1,r}},n.__traitInit&&!n.hasOwnProperty("__traitInit")&&(n.__traitInit=n.__traitInit.slice()),n.__traitInit||(n.__traitInit=[]),n.__traitInit.push(function(n,r){this._channelId=n,this._channel=r,this._done={}}),n.rollBack=function(n,r){n&&r&&r.rollBack&&n.reverseToLine(r.rollBackTo)}}(this)},e=function(n,r,t,a,o,i,c,l){var s,f=this;if(!(f instanceof e))return new e(n,r,t,a,o,i,c,l);var u=[n,r,t,a,o,i,c,l];if(f.__factoryClass)if(f.__factoryClass.forEach(function(n){s=n.apply(f,u)}),"function"==typeof s){if(s._classInfo.name!=e._classInfo.name)return new s(n,r,t,a,o,i,c,l)}else if(s)return s;f.__traitInit?f.__traitInit.forEach(function(n){n.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};e._classInfo={name:"_chPolicy"},e.prototype=new r,function(){"undefined"!=typeof define&&null!==define&&null!=define.amd?(n._chPolicy=e,this._chPolicy=e):"undefined"!=typeof module&&null!==module&&null!=module.exports?module.exports._chPolicy=e:this._chPolicy=e}.call(new Function("return this")()),function(n){n.__traitInit&&!n.hasOwnProperty("__traitInit")&&(n.__traitInit=n.__traitInit.slice()),n.__traitInit||(n.__traitInit=[]),n.__traitInit.push(function(){})}(this)},e=function(n,r,t,a,o,i,c,l){var s,f=this;if(!(f instanceof e))return new e(n,r,t,a,o,i,c,l);var u=[n,r,t,a,o,i,c,l];if(f.__factoryClass)if(f.__factoryClass.forEach(function(n){s=n.apply(f,u)}),"function"==typeof s){if(s._classInfo.name!=e._classInfo.name)return new s(n,r,t,a,o,i,c,l)}else if(s)return s;f.__traitInit?f.__traitInit.forEach(function(n){n.apply(f,u)}):"function"==typeof f.init&&f.init.apply(f,u)};e._classInfo={name:"channelPolicyModule"},e.prototype=new r,"undefined"!=typeof define&&null!==define&&null!=define.amd&&define(n)}).call(new Function("return this")());